<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#2563eb">
  <title>Foosball</title>
  <meta name="application-name" content="Foosball" />
  <meta name="apple-mobile-web-app-title" content="Foosball" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0a101f" />
  <link rel="manifest" href="manifest.json">

    <style>
    :root {
      --bg: #0a101f;
      --panel: rgba(14, 22, 43, 0.76);
      --panel-strong: rgba(10, 17, 36, 0.92);
      --stroke: rgba(148, 163, 184, 0.18);
      --text: #f8fafc;
      --muted: #9aa7bd;
      --accent: #00d4ff;
      --accent-2: #f59e0b;
      --accent-3: #22c55e;
      --accent-4: #ef4444;
      --shadow: 0 24px 60px rgba(2, 6, 23, 0.55);
      --gap: 18px;
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    html, body {
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Vazirmatn", "Tahoma", "Segoe UI", sans-serif;
      background: radial-gradient(1200px 700px at 90% -10%, rgba(0, 212, 255, 0.2), transparent 60%),
                  radial-gradient(900px 600px at -10% 20%, rgba(245, 158, 11, 0.18), transparent 60%),
                  linear-gradient(180deg, #070b16 0%, #0a101f 55%, #0c1222 100%);
      color: var(--text);
      letter-spacing: -0.2px;
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
    }
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,0.03) 0 1px, transparent 1px 6px);
      pointer-events: none;
      mix-blend-mode: soft-light;
      opacity: 0.35;
    }
    header.hero {
      padding: 28px 18px 18px;
      position: sticky;
      top: 0;
      backdrop-filter: blur(12px);
      background: rgba(6, 10, 22, 0.75);
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      z-index: 20;
    }
    .hero-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      object-fit: cover;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.45);
    }
    .eyebrow {
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 3px;
      font-size: 11px;
      color: var(--accent);
    }
    h1 { margin: 6px 0 6px; font-size: clamp(22px, 3vw, 32px); }
    .subtle { margin: 0; color: var(--muted); font-size: 13px; }
    .hero-meta { display: flex; gap: 12px; flex-wrap: wrap; }
    .stat {
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(12, 18, 36, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.15);
      min-width: 130px;
      text-align: center;
    }
    .stat .label { font-size: 11px; color: var(--muted); }
    .stat .value { font-weight: 800; font-size: 18px; }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 18px 48px;
      display: grid;
      gap: var(--gap);
    }
    .stack { display: grid; gap: var(--gap); }
    .span-2 { grid-column: 1 / -1; }

    @media (min-width: 980px) {
      .wrap { grid-template-columns: 1.1fr 0.9fr; align-items: start; }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      animation: rise 0.7s ease both;
      animation-delay: var(--delay, 0s);
    }

    @keyframes rise {
      from { transform: translateY(16px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(500px 220px at 85% -20%, rgba(0,212,255,0.12), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0, 212, 255, 0.12);
      border: 1px solid rgba(0, 212, 255, 0.35);
      color: var(--text);
      font-weight: 600;
    }
    .muted { color: var(--muted); font-size: 12px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row.center { justify-content: center; }

    input, select, button {
      font-family: inherit;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(7, 11, 24, 0.7);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      min-height: 44px;
      font-size: 15px;
    }
    input { flex: 1; min-width: 150px; }
    input:focus, button:focus-visible { border-color: rgba(0, 212, 255, 0.6); box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.15); }
    button { cursor: pointer; font-weight: 700; }
    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }

    .primary { background: linear-gradient(120deg, #00d4ff, #38bdf8); border-color: transparent; color: #04111f; }
    .good { background: linear-gradient(120deg, #22c55e, #4ade80); border-color: transparent; color: #03140b; }
    .warn { background: linear-gradient(120deg, #f59e0b, #fbbf24); border-color: transparent; color: #1c1203; }
    .danger { background: linear-gradient(120deg, #ef4444, #f97316); border-color: transparent; color: #2b0707; }
    .ghost { background: rgba(12, 18, 36, 0.6); border-color: rgba(148,163,184,0.25); color: var(--text); }

    .hr { height: 1px; background: rgba(148, 163, 184, 0.14); margin: 14px 0; }

    ol, ul { margin: 10px 0 0; padding: 0; list-style: none; }
    li {
      margin: 8px 0;
      padding: 12px 14px;
      background: rgba(15, 23, 42, 0.65);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      display: grid;
      gap: 6px;
    }
    li.empty {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    .teamTitle { font-weight: 800; }
    .queue-meta { display: flex; align-items: center; gap: 6px; }
    .queue-item { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .queue-info { display: grid; gap: 4px; }
    .queue-actions { display: flex; gap: 6px; flex-wrap: wrap; opacity: 1; pointer-events: auto; transition: opacity 0.2s ease; }
    .queue-actions button {
      padding: 8px 12px;
      font-size: 13px;
      min-height: 38px;
    }
    .drag-handle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(8, 13, 28, 0.7);
      cursor: grab;
      font-weight: 700;
      color: var(--muted);
    }
    .queue--edit li {
      cursor: grab;
      /* touch-action: none; */
    }

    .drag-handle { opacity: 1; transition: opacity 0.2s ease; }
    .dragging { opacity: 0.5; border-style: dashed; }

    .scoreboard {
      display: grid;
      gap: 14px;
    }
    @media (min-width: 720px) {
      .scoreboard { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .teamCard {
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(9, 13, 28, 0.75);
      position: relative;
      overflow: hidden;
    }
    .teamCard.active {
      border-color: rgba(0, 212, 255, 0.6);
      box-shadow: 0 0 0 1px rgba(0, 212, 255, 0.2), 0 16px 35px rgba(0, 212, 255, 0.15);
    }
    .teamCard.waiting {
      border-color: rgba(245, 158, 11, 0.6);
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.2), 0 16px 35px rgba(245, 158, 11, 0.15);
    }
    .teamHead {
      display: flex;
      align-items: center;
      gap: 8px;
      
    }
    .side {
      font-weight: 800;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0, 212, 255, 0.12);
      border: 1px solid rgba(0, 212, 255, 0.35);
    }
    .teamName { font-weight: 800; font-size: 16px; }

    .scoreRow {
      display: grid;
      grid-template-columns: 48px 1fr 48px;
      align-items: center;
      gap: 12px;
      margin-top: 14px;
    }

    .score {
      font-size: 22px;
      min-height: 48px;
      text-align: center;
      font-variant-numeric: tabular-nums;
      color: var(--text);
    }
    .goal {
      font-size: 20px;
      font-weight: 800;
      padding: 8px 0;
    }

    .timerCard {
      display: grid;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.25);
      background: rgba(8, 13, 28, 0.7);
    }
    .timerControls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .timerDisplay {
      min-width: 140px;
      text-align: center;
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(0, 212, 255, 0.12);
      border: 1px solid rgba(0, 212, 255, 0.35);
    }
    .timerValue {
      font-size: 32px;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
    }
    .timerUnit { font-size: 11px; color: var(--muted); }

    .match-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .results-list li {
      grid-template-columns: 1fr;
    }
    .result-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .result-score {
      font-size: 20px;
      font-weight: 800;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
 
    #resultsContainer {
      max-height: 300px;     
      overflow-y: auto;  
      -webkit-overflow-scrolling: touch;     
    }

    .badge {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
    }
    .badge.win { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.4); }
    .badge.draw { background: rgba(245, 158, 11, 0.2); color: #fde68a; border: 1px solid rgba(245, 158, 11, 0.4); }

    .table-wrap { 
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; 
    }
    .league-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .league-table th,
    .league-table td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      font-variant-numeric: tabular-nums;
    }
    .league-table th { color: var(--muted); font-weight: 700; }
    .league-table td.name { text-align: right; font-weight: 700; }
    .league-table td.rank { color: var(--muted); width: 32px; }

    .footer-note { font-size: 12px; color: var(--muted); margin-top: 12px; }

    @media (max-width: 680px) {
      header.hero { position: static; }
      .stat { min-width: 110px; }
      .score { font-size: 36px; }
    }
    #btnForfeitA,
#btnForfeitB {
  background-color: #ef4444; 
  color: white;
  border: none;
  padding: 6px 12px;       
  margin: 2px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  display: inline-flex;    
  align-items: center;     
  justify-content: center;  
  min-width: 60px;         
  height: 32px;            
  box-sizing: border-box;   
  transition: background-color 0.2s;
}

#btnForfeitA:disabled,
#btnForfeitB:disabled {
  background-color: #fca5a5; 
  cursor: not-allowed;
}

#btnForfeitA:hover:not(:disabled),
#btnForfeitB:hover:not(:disabled) {
  background-color: #dc2626; 
}

@media (max-width: 640px) {

  .row.center {
    flex-direction: column;
    align-items: stretch;
  }

  .row.center button {
    width: 100%;
  }

}

@media (max-width: 640px) {

  .timerControls {
    flex-direction: column;
    align-items: stretch;
  }

  .timerDisplay {
    width: 100%;
  }

}
@media (max-width: 640px) {
  .league-table {
    font-size: 12px;
  }
}

button:active {
  transform: scale(0.96);
}


  </style>
</head>
<body>

  <header class="hero">
    <div class="hero-inner">
      <div>
        <div class="brand">
          <div>
            <div class="eyebrow">FOOSBALL QUEUE</div>
            <h1>مدیریت صف فوتبال‌دستی</h1>
          </div>
        </div>
        <p class="subtle">قانون بازی: تا ۲ گل — برنده می‌ماند، بازنده ته صف. مساوی؟ هر دو ته صف. تایمر هم بر حسب ثانیه است.</p>
      </div>
      <div class="hero-meta">
        <div class="stat">
          <div class="label">تیم‌ها در صف</div>
          <div class="value" id="qCountHero">0</div>
        </div>
        <div class="stat">
          <div class="label">حد نصاب گل</div>
          <div class="value">2</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card span-2" style="--delay:0.02s">
      <div class="card-head">
        <span class="pill">کنترل بازی</span>
        <span class="muted"></span>
      </div>

      <div class="hr"></div>

      <div class="timerCard">
        <div class="timerControls">
          <div>
            <div class="muted">زمان هر بازی (ثانیه)</div>
            <input id="seconds" type="number" min="10" step="5" style="max-width:140px" />
          </div>
          <div class="timerDisplay">
            <div class="timerValue" id="timer">90</div>
            <div class="timerUnit">ثانیه</div>
          </div>
        </div>
        <div class="row center">
          <button id="btnTimerPause" class="ghost">توقف</button>
          <button id="btnTimerReset" class="ghost">ریست</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row center">
        <button id="btnStartMatch" class="primary">شروع بازی بعدی</button>
        <button id="btnWinA" class="good">برد تیم A</button>
        <button id="btnDraw" class="warn">مساوی</button>
        <button id="btnWinB" class="good">برد تیم B</button>
        <button id="btnUndoStage" class="danger">برگشت به بازی قبل</button>
      </div>
    </section>

    <section class="card span-2" style="--delay:0.08s">
      <div class="card-head">
        <span class="pill">بازی جاری</span>
        <div class="match-status" id="matchStatus">هنوز بازی شروع نشده</div>
      </div>

      <div class="hr"></div>

      <div class="scoreboard">
        <div class="teamCard" id="teamCardA">
          <div class="teamHead">
            <span class="side">A</span>
            <span class="teamName" id="teamAName">—</span>
          </div>
          <div class="scoreRow">
            <button id="btnUndoA" class="ghost">-</button>
            <div class="score" id="scoreA">0</div>
            <button id="btnGoalA" class="good goal">+</button>
            <button id="btnForfeitA">انصراف</button>
          </div>
        </div>

        <div class="teamCard" id="teamCardB">
          <div class="teamHead">
            <span class="side">B</span>
            <span class="teamName" id="teamBName">—</span>
          </div>
          <div class="scoreRow">
            <button id="btnUndoB" class="ghost">-</button>
            <div class="score" id="scoreB">0</div>
            <button id="btnGoalB" class="good goal">+</button>
            <button id="btnForfeitB">انصراف</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="--delay:0.05s">
      <div class="card-head">
        <span class="pill">صف تیم‌ها</span>
        <div class="row">
          <button id="btnClear" class="danger">پاک کردن صف</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="teamName" placeholder="نام تیم (مثلاً تیم ۵)" />
        <input id="insertPos" type="number" min="1" placeholder="جایگاه در صف" style="max-width:140px" />
        <button id="btnAdd" class="primary">افزودن تیم</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnAddQuick" class="ghost">افزودن سریع تیم جدید</button>
        <button id="btnRemoveLast" class="warn">حذف آخر صف</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between">
        <div class="queue-meta">
          <span class="teamTitle">در انتظار:</span>
          <span class="muted" id="qCount"></span>
        </div>
      </div>

      <ol id="queue"></ol>
      <div class="footer-note">برنده روی میز می‌ماند و حریف بعدی به‌صورت خودکار می‌آید.</div>
    </section>

    <section class="card" style="--delay:0.18s">
      <div class="card-head">
        <span class="pill">نتایج بازی</span>
        <button id="btnClearResults" class="ghost">پاک کردن نتایج</button>
      </div>
      <div id="resultsContainer" >
        <ul id="results" class="results-list"></ul>
        <div class="muted" id="resultsEmpty">هنوز نتیجه‌ای ثبت نشده.</div>
      </div>
      
    </section>

    <section class="card span-2" style="--delay:0.22s">
      <div class="card-head">
        <span class="pill">جدول لیگ</span>
        <span class="muted">برد/مساوی/باخت و گل زده/خورده</span>
      </div>

      <div class="table-wrap">
        <table class="league-table">
          <thead>
            <tr>
              <th>#</th>
              <th>تیم</th>
              <th>برد</th>
              <th>مساوی</th>
              <th>باخت</th>
              <th>گل زده</th>
              <th>گل خورده</th>
              <th>تفاضل</th>
              <th>بازی</th>
              <th>امتیاز</th>
            </tr>
          </thead>
          <tbody id="standings"></tbody>
        </table>
      </div>
      <div class="muted" id="standingsEmpty">هنوز نتیجه‌ای ثبت نشده.</div>
    </section>
  </main>

<script>
(() => {
  const GOAL_LIMIT = 2;
  const DEFAULT_SECONDS = 90;
  const RESULT_LIMIT = 200;
  const STORAGE_KEY = "foos_queue_state_v3";
  const LEGACY_KEYS = ["foos_queue_state_v2", "foos_queue_state_v1"];
  const $ = (id) => document.getElementById(id);

  const els = {
    teamName: $("teamName"), insertPos: $("insertPos"),
    btnAdd: $("btnAdd"), btnAddQuick: $("btnAddQuick"),
    btnClear: $("btnClear"), btnRemoveLast: $("btnRemoveLast"),
    queue: $("queue"), qCount: $("qCount"), qCountHero: $("qCountHero"),
    matchStatus: $("matchStatus"),
    teamAName: $("teamAName"), teamBName: $("teamBName"),
    scoreA: $("scoreA"), scoreB: $("scoreB"),
    teamCardA: $("teamCardA"), teamCardB: $("teamCardB"),
    btnGoalA: $("btnGoalA"), btnGoalB: $("btnGoalB"),
    btnUndoA: $("btnUndoA"), btnUndoB: $("btnUndoB"),
    btnStartMatch: $("btnStartMatch"), btnWinA: $("btnWinA"), btnDraw: $("btnDraw"), btnWinB: $("btnWinB"),
    seconds: $("seconds"), timer: $("timer"),
    btnTimerPause: $("btnTimerPause"), btnTimerReset: $("btnTimerReset"),
    results: $("results"), resultsEmpty: $("resultsEmpty"),
    standings: $("standings"), standingsEmpty: $("standingsEmpty"),
    btnClearResults: $("btnClearResults"),
    btnForfeitA: $("btnForfeitA"),
    btnForfeitB: $("btnForfeitB"),
    btnUndoStage: $("btnUndoStage"),
  };

  let state = {
    queue: [],
    playing: null, // {A, B|null, scoreA, scoreB}
    quickTeamNo: 1,
    results: [],
    durationSec: DEFAULT_SECONDS,
    remainingSec: DEFAULT_SECONDS,
    ticking: false,
    matchLive: false
  };
  let timerInterval = null;
  let history = [];

  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const pushHistory = () => {
  history.push(JSON.parse(JSON.stringify(state)));
  if (history.length > 100) history.shift();
  };
  const load = () => {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const s = JSON.parse(raw);
      if (s && Array.isArray(s.queue)) state.queue = s.queue;
      if (s && Array.isArray(s.results)) state.results = s.results;
      if (s && Number.isFinite(s.quickTeamNo)) state.quickTeamNo = s.quickTeamNo;
      if (s && Number.isFinite(s.durationSec)) state.durationSec = s.durationSec;
      if (s && Number.isFinite(s.remainingSec)) state.remainingSec = s.remainingSec;
      if (s && typeof s.matchLive === "boolean") state.matchLive = s.matchLive;

      if (s && s.playing && s.playing.A) {
        state.playing = {
          A: s.playing.A,
          B: s.playing.B ?? null,
          scoreA: Number.isFinite(s.playing.scoreA) ? s.playing.scoreA : 0,
          scoreB: Number.isFinite(s.playing.scoreB) ? s.playing.scoreB : 0,
        };
      }
    } catch {}
  };
  const clearLegacyKeys = () => {
    LEGACY_KEYS.forEach((key) => localStorage.removeItem(key));
  };

  const escapeHtml = (s) => (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const formatTime = (ts) => {
    if (!ts) return "";
    try {
      return new Intl.DateTimeFormat("fa-IR", { dateStyle: "short", timeStyle: "short" }).format(new Date(ts));
    } catch {
      return new Date(ts).toLocaleString();
    }
  };


  const beep = () => {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g);
      g.connect(ctx.destination);
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.05;
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 300);
    } catch {}
  };

  const addResult = (entry) => {
    state.results.unshift(entry);
    state.results = state.results.slice(0, RESULT_LIMIT);
  };

  const defaultTeamName = () => {
    const n = state.quickTeamNo;
    state.quickTeamNo += 1;
    return `تیم ${n}`;
  };

  const addTeam = (team, position) => {
    
    if (Number.isFinite(position)) {
      const index = Math.max(0, Math.min(state.queue.length, position - 1));
      state.queue.splice(index, 0, team);
    } else {
      state.queue.push(team);
    }
    pushHistory();
    render();
  };

  const stopTimer = () => {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    state.ticking = false;
  };

  const resetTimer = () => {
    stopTimer();
    state.remainingSec = state.durationSec;
  };

  const startTimer = () => {
    if (state.ticking || !state.playing || !state.playing.B) return;
    if (state.remainingSec <= 0) state.remainingSec = state.durationSec;
    state.ticking = true;
    timerInterval = setInterval(() => {
      state.remainingSec = Math.max(0, state.remainingSec - 1);
      if (state.remainingSec <= 0) {
        stopTimer();
        beep();
      }
      render();
    }, 1000);
    render();
  };

  const pauseTimer = () => {
    if (!state.ticking) return;
    stopTimer();
    render();
  };

  const toggleTimer = () => {
    if (state.ticking) {
      pauseTimer();
    } else {
      startTimer();
    }
  };

  const setMatch = (A, B, autoStart = false) => {
    state.playing = { A, B, scoreA: 0, scoreB: 0 };
    resetTimer();
    state.matchLive = false;
    if (B && autoStart) {
      state.matchLive = true;
      startTimer();
    } else {
      render();
    }
  };

  const startMatch = () => {
    
    if (state.playing && state.playing.B) {
      if (!state.matchLive) {
        state.matchLive = true;
        resetTimer();
        startTimer();
      }
      return;
    }

    pushHistory();

    if (state.playing && !state.playing.B) {
      if (state.queue.length < 1) return;
      const nextOpponent = state.queue.shift();
      setMatch(state.playing.A, nextOpponent, true);
      return;
    }

    if (state.playing) return;
    if (state.queue.length < 2) return;
    const A = state.queue.shift();
    const B = state.queue.shift();
    setMatch(A, B, true);
  };

  const endMatchDraw = () => {
    
    if (!state.playing || !state.playing.B) return;
    pushHistory();
    stopTimer();
    state.matchLive = false;
    const A = state.playing.A;
    const B = state.playing.B;

    addResult({
      A, B,
      scoreA: state.playing.scoreA,
      scoreB: state.playing.scoreB,
      outcome: "draw",
      ts: Date.now()
    });

    // both to end of queue, keeping original priority
    state.queue.push(A, B);
    if (state.queue.length >= 2) {
      const nextA = state.queue.shift();
      const nextB = state.queue.shift();
      setMatch(nextA, nextB, false);
    } else {
      state.playing = null;
      resetTimer();
      render();
    }
  };

  const endMatchWithWinner = (winnerKey) => {
    
    if (!state.playing || !state.playing.B) return;
    pushHistory();
    stopTimer();
    state.matchLive = false;

    const A = state.playing.A;
    const B = state.playing.B;
    const winner = winnerKey === "A" ? A : B;
    const loser = winnerKey === "A" ? B : A;
    // ⭐ این بخش را اضافه کن
    if (state.playing.scoreA === 0 && state.playing.scoreB === 0){
      if (winnerKey === "A"){
        state.playing.scoreA = 1;
      } else {
        state.playing.scoreB = 1;
      }
    }
    addResult({
      A, B,
      scoreA: state.playing.scoreA,
      scoreB: state.playing.scoreB,
      outcome: winnerKey,
      ts: Date.now()
    });

    state.queue.push(loser);
    const nextOpponent = state.queue.shift() || null;
    if (nextOpponent) {
      setMatch(winner, nextOpponent, false);
    } else {
      state.playing = { A: winner, B: null, scoreA: 0, scoreB: 0 };
      resetTimer();
      render();
    }
  };

  const forfeitTeam = (key) => {
    
  if (!state.playing || !state.playing.B) return;
  pushHistory();
  // حذف تیم از صف اگر هنوز در صف باشد
  const team = key === "A" ? state.playing.A : state.playing.B;
  const indexInQueue = state.queue.findIndex(t => t === team);
  if (indexInQueue !== -1) state.queue.splice(indexInQueue, 1);

  // بازی جاری را به حالت فقط تیم دیگر نگه می‌داریم
  if (key === "A") {
    state.playing = { A: state.playing.B, B: null, scoreA: 0, scoreB: 0 };
  } else {
    state.playing = { A: state.playing.A, B: null, scoreA: 0, scoreB: 0 };
  }

  state.matchLive = false; // بازی هنوز شروع نشده
  stopTimer();
  render();
};

  const scoreGoal = (key) => {
    if (!state.playing || !state.playing.B) return;
    if (key === "A") {
      if (state.playing.scoreA >= GOAL_LIMIT) return;
      state.playing.scoreA += 1;
      if (state.playing.scoreA >= GOAL_LIMIT) {
        endMatchWithWinner("A");
        return;
      }
    } else {
      if (state.playing.scoreB >= GOAL_LIMIT) return;
      state.playing.scoreB += 1;
      if (state.playing.scoreB >= GOAL_LIMIT) {
        endMatchWithWinner("B");
        return;
      }
    }
    render();
  };

  const undoGoal = (key) => {
    if (!state.playing || !state.playing.B) return;
    if (key === "A") {
      state.playing.scoreA = Math.max(0, state.playing.scoreA - 1);
    } else {
      state.playing.scoreB = Math.max(0, state.playing.scoreB - 1);
    }
    render();
  };

  const editTeam = (index) => {
    const t = state.queue[index];
    if (!t) return;
    const name = prompt("نام تیم", t.name || "");
    if (name === null) return;
      state.queue[index] = {
        ...t,
        name: name.trim() || t.name || defaultTeamName()
      };
    render();
  };

  const deleteTeam = (index) => {
   
    if (!Number.isFinite(index)) return;
    state.queue.splice(index, 1);
    pushHistory();
    render();
  };

  const renderQueue = () => {
    els.queue.innerHTML = "";
    if (state.queue.length === 0) {
      const li = document.createElement("li");
      li.className = "empty";
      li.textContent = "فعلاً تیمی در صف نیست.";
      els.queue.appendChild(li);
      return;
    }
    state.queue.forEach((t, i) => {
      const li = document.createElement("li");
      li.dataset.index = String(i);
      li.draggable = true;
      li.innerHTML = `
        <div class="queue-item">
          <div class="queue-info">
            <div><b>${i + 1}.</b> <span class="teamTitle">${escapeHtml(t.name)}</span></div>
          </div>
          <div class="queue-actions">
            <span class="drag-handle" title="جابجایی">⋮⋮</span>
            <button class="ghost" data-action="edit" data-index="${i}">ویرایش</button>
            <button class="danger" data-action="delete" data-index="${i}">حذف</button>
          </div>
        </div>
      `;
      els.queue.appendChild(li);
    });
    els.queue.classList.add("queue--edit");
  };

  const renderPlaying = () => {
    const playing = state.playing;
    const hasMatch = playing && playing.B;
    const waiting = playing && !playing.B;
    const ready = hasMatch && !state.matchLive;

    if (!playing) {
      els.teamAName.textContent = "—";
      els.teamBName.textContent = "—";
      els.scoreA.textContent = "0";
      els.scoreB.textContent = "0";
      els.matchStatus.textContent = "هنوز بازی شروع نشده";
      els.teamCardA.classList.remove("active", "waiting");
      els.teamCardB.classList.remove("active", "waiting");
    } else {
      els.teamAName.textContent = playing.A.name;
      els.scoreA.textContent = String(playing.scoreA ?? 0);

      if (playing.B) {
        els.teamBName.textContent = playing.B.name;
        els.scoreB.textContent = String(playing.scoreB ?? 0);
        els.matchStatus.textContent = ready
          ? `آماده شروع: ${playing.A.name} vs ${playing.B.name}`
          : `بازی جاری: ${playing.A.name} vs ${playing.B.name}`;
      } else {
        els.teamBName.textContent = "منتظر حریف";
        els.scoreB.textContent = "0";
        els.matchStatus.textContent = `برنده روی میز: ${playing.A.name}`;
      }

      els.teamCardA.classList.toggle("active", hasMatch);
      els.teamCardA.classList.toggle("waiting", waiting);
      els.teamCardB.classList.toggle("active", hasMatch);
      els.teamCardB.classList.toggle("waiting", waiting && !hasMatch);
    }

    if (!playing) {
      els.btnStartMatch.textContent = "شروع بازی بعدی";
      els.btnStartMatch.disabled = state.queue.length < 2;
    } else if (waiting) {
      els.btnStartMatch.textContent = "شروع بازی بعدی";
      els.btnStartMatch.disabled = state.queue.length < 1;
    } else if (ready) {
      els.btnStartMatch.textContent = "شروع بازی";
      els.btnStartMatch.disabled = false;
    } else {
      els.btnStartMatch.textContent = "بازی در حال اجرا";
      els.btnStartMatch.disabled = true;
    }

    const enableMatchActions = !!hasMatch && state.matchLive;
    els.btnGoalA.disabled = !enableMatchActions;
    els.btnGoalB.disabled = !enableMatchActions;
    els.btnUndoA.disabled = !enableMatchActions;
    els.btnUndoB.disabled = !enableMatchActions;
    els.btnWinA.disabled = !enableMatchActions;
    els.btnDraw.disabled = !enableMatchActions;
    els.btnWinB.disabled = !enableMatchActions;
    // فعال بودن دکمه انصراف فقط قبل از شروع بازی
    const enableForfeit = !!(state.playing && state.playing.B) && !state.matchLive;
    els.btnForfeitA.disabled = !enableForfeit;
    els.btnForfeitB.disabled = !enableForfeit;
  };

  const renderResults = () => {
    els.results.innerHTML = "";
    if (!state.results.length) {
      els.resultsEmpty.style.display = "block";
      return;
    }
    els.resultsEmpty.style.display = "none";
    state.results.forEach((r) => {
      const li = document.createElement("li");
      const outcome = resolveOutcome(r);
      const outcomeLabel = outcome === "draw"
        ? "مساوی"
        : outcome === "A"
          ? `برد ${r.A?.name || "تیم A"}`
          : `برد ${r.B?.name || "تیم B"}`;
      const badgeClass = outcome === "draw" ? "draw" : "win";

      li.innerHTML = `
        <div class="result-head">
          <div class="result-score">${r.scoreA ?? 0} - ${r.scoreB ?? 0}</div>
          <span class="badge ${badgeClass}">${escapeHtml(outcomeLabel)}</span>
        </div>
        <div class="teamTitle">${escapeHtml(r.A?.name || "تیم A")}  —  ${escapeHtml(r.B?.name || "تیم B")}</div>
        <div class="muted">${escapeHtml(formatTime(r.ts))}</div>
      `;
      els.results.appendChild(li);
    });
  };

  const resolveOutcome = (r) => {
    const outcome = r?.outcome;
    if (outcome === "A" || outcome === "B" || outcome === "draw") return outcome;
    const scoreA = Number.isFinite(r?.scoreA) ? r.scoreA : 0;
    const scoreB = Number.isFinite(r?.scoreB) ? r.scoreB : 0;
    if (scoreA === scoreB) return "draw";
    return scoreA > scoreB ? "A" : "B";
  };

  const buildStandings = () => {
    const table = new Map();
    const ensure = (name) => {
      const key = (name || "").trim() || "بدون‌نام";
      if (!table.has(key)) {
        table.set(key, { name: key, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0 });
      }
      return table.get(key);
    };

    state.results.forEach((r) => {
      const aName = r?.A?.name || "تیم A";
      const bName = r?.B?.name || "تیم B";
      const scoreA = Number.isFinite(r?.scoreA) ? r.scoreA : 0;
      const scoreB = Number.isFinite(r?.scoreB) ? r.scoreB : 0;
      const a = ensure(aName);
      const b = ensure(bName);
      a.gf += scoreA;
      a.ga += scoreB;
      b.gf += scoreB;
      b.ga += scoreA;

      const outcome = resolveOutcome(r);
      if (outcome === "draw") {
        a.draws += 1;
        b.draws += 1;
      } else if (outcome === "A") {
        a.wins += 1;
        b.losses += 1;
      } else {
        b.wins += 1;
        a.losses += 1;
      }
    });

    const rows = [...table.values()];
    const points = (t) => t.wins * 3 + t.draws;
    rows.sort((x, y) => {
      const byPoints = points(y) - points(x);
      if (byPoints !== 0) return byPoints;
      const byGoalDiff = (y.gf - y.ga) - (x.gf - x.ga);
      if (byGoalDiff !== 0) return byGoalDiff;
      if (y.gf !== x.gf) return y.gf - x.gf;
      if (y.wins !== x.wins) return y.wins - x.wins;
      return x.name.localeCompare(y.name, "fa");
    });
    return rows;
  };

  const renderStandings = () => {
    if (!els.standings || !els.standingsEmpty) return;
    els.standings.innerHTML = "";
    const rows = buildStandings();
    if (!rows.length) {
      els.standingsEmpty.style.display = "block";
      return;
    }
    els.standingsEmpty.style.display = "none";
    rows.forEach((row, index) => {
      const tr = document.createElement("tr");

      const pts = row.wins * 3 + row.draws;
      const diff = row.gf - row.ga;
      const diffColor = diff > 0 ? "#22c55e" : diff < 0 ? "#ef4444" : "#9aa7bd";
      const played = row.wins + row.draws + row.losses;

      tr.innerHTML = `
        <td class="rank">${index + 1}</td>
        <td class="name">${escapeHtml(row.name)}</td>
        <td>${row.wins}</td>
        <td>${row.draws}</td>
        <td>${row.losses}</td>
        <td>${row.gf}</td>
        <td>${row.ga}</td>
        <td style="color:${diffColor};font-weight:700">${diff}</td>
        <td>${played}</td>
        <td><b>${pts}</b></td>
      `;
      els.standings.appendChild(tr);
    });
  };

  const renderTimer = () => {
    els.timer.textContent = String(state.remainingSec ?? state.durationSec);
    els.seconds.value = String(state.durationSec);
    const hasMatch = !!(state.playing && state.playing.B);
    if (els.btnTimerPause) {
      els.btnTimerPause.textContent = !hasMatch ? "توقف" : (state.ticking ? "توقف" : "ادامه");
    }
    els.btnTimerPause.disabled = !hasMatch || !state.matchLive;
    els.btnTimerReset.disabled = !hasMatch;
  };

  const render = () => {
    renderQueue();
    renderPlaying();
    renderResults();
    renderStandings();
    renderTimer();
    els.qCount.textContent = `(${state.queue.length} تیم)`;
    if (els.qCountHero) els.qCountHero.textContent = String(state.queue.length);
    els.btnRemoveLast.disabled = state.queue.length === 0;
    els.btnClear.disabled = state.queue.length === 0 && !state.playing;
    save();
  };

  // events

  els.btnAdd.addEventListener("click", () => {
    const name = (els.teamName.value || "").trim() || defaultTeamName();
    const posRaw = parseInt(els.insertPos.value || "", 10);
    const position = Number.isFinite(posRaw) ? posRaw : null;
    addTeam({ name }, position);
    els.teamName.value = ""; els.insertPos.value = "";
    els.teamName.focus();
  });

  els.btnAddQuick.addEventListener("click", () => {
    const posRaw = parseInt(els.insertPos.value || "", 10);
    const position = Number.isFinite(posRaw) ? posRaw : null;
    addTeam({ name: defaultTeamName() }, position);
    els.insertPos.value = "";
  });

  els.btnClear.addEventListener("click", () => {
   
    if (!confirm("صف و بازی جاری پاک شود؟")) return;
    pushHistory();
    localStorage.removeItem(STORAGE_KEY);
    clearLegacyKeys();
    state.queue = [];
    state.playing = null;
    state.quickTeamNo = 1;
    resetTimer();
    render();
  });

  els.btnClearResults.addEventListener("click", () => {
    
    if (!confirm("همه نتایج پاک شود؟")) return;
    pushHistory();
    state.results = [];
    render();
  });

  els.btnRemoveLast.addEventListener("click", () => {
    state.queue.pop();
    render();
  });

  els.queue.addEventListener("click", (event) => {
    const target = event.target.closest("button[data-action]");
    if (!target) return;
    const index = parseInt(target.dataset.index || "", 10);
    if (target.dataset.action === "edit") editTeam(index);
    if (target.dataset.action === "delete") deleteTeam(index);
  });

  els.btnUndoStage.addEventListener("click", () => {
  if (!history.length) return;

  stopTimer();

  state = history.pop();

  render();
  });


  els.btnStartMatch.addEventListener("click", () => startMatch());
  els.btnWinA.addEventListener("click", () => endMatchWithWinner("A"));
  els.btnDraw.addEventListener("click", () => endMatchDraw());
  els.btnWinB.addEventListener("click", () => endMatchWithWinner("B"));
  els.btnGoalA.addEventListener("click", () => scoreGoal("A"));
  els.btnGoalB.addEventListener("click", () => scoreGoal("B"));
  els.btnUndoA.addEventListener("click", () => undoGoal("A"));
  els.btnUndoB.addEventListener("click", () => undoGoal("B"));
  els.btnTimerPause.addEventListener("click", () => toggleTimer());
  els.btnTimerReset.addEventListener("click", () => { resetTimer(); render(); });
  els.seconds.addEventListener("change", () => {
    const raw = parseInt(els.seconds.value || "", 10);
    const next = Number.isFinite(raw) ? Math.max(10, raw) : DEFAULT_SECONDS;
    state.durationSec = next;
    resetTimer();
    render();
  });
  els.btnForfeitA.addEventListener("click", () => forfeitTeam("A"));
  els.btnForfeitB.addEventListener("click", () => forfeitTeam("B"));

 

  // init
  load();
  clearLegacyKeys();
  state.durationSec = Math.max(10, Number.isFinite(state.durationSec) ? Math.floor(state.durationSec) : DEFAULT_SECONDS);
  state.remainingSec = Number.isFinite(state.remainingSec)
    ? Math.min(state.durationSec, Math.max(0, Math.floor(state.remainingSec)))
    : state.durationSec;
  state.ticking = false;
  state.matchLive = false;
  render();
})();

if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker registered', reg))
        .catch(err => console.log('Service Worker registration failed', err));
    });
  }
</script>
</body>
</html>
